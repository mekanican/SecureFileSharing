from http.server import BaseHTTPRequestHandler
import json

from .check_hash import classify_malware

API_ENDPOINT = "/api/malware"


class MalwareDetectionAPI(BaseHTTPRequestHandler):
    def _set_response(self, status_code=200, content_type='application/json'):
        self.send_response(status_code)
        self.send_header('Content-type', content_type)
        self.end_headers()

    def do_POST(self):
        if self.path == API_ENDPOINT:
            content_length = int(self.headers['Content-Length'])
            request_body = self.rfile.read(content_length).decode('utf-8')

            # Parse the JSON payload
            payload = json.loads(request_body)
            hash_value = payload['hash']

            # Perform classification based on the hash
            result = classify_malware(hash_value)

            # Prepare the response
            response_data = {'result': result}

            # Send the response
            self._set_response()
        else:
            # Return a json with an error message
            response_data = {'error': 'Not found'}
            self._set_response(404)

        response = json.dumps(response_data)
        self.wfile.write(response.encode('utf-8'))